# Use official Python 3.11 image as base
FROM python:3.11-slim

# Prevent Python from buffering stdout/stderr
ENV PYTHONUNBUFFERED=1
ENV LC_ALL=C.UTF-8
ENV LANG=C.UTF-8
ENV SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt
# You can mount GOOGLE_APPLICATION_CREDENTIALS at /credentials/google_creds.json if needed

# Set working dir
WORKDIR /app

# Copy application files
COPY AlgoTuner /app/AlgoTuner
COPY AlgoTuneTasks /app/AlgoTuneTasks
COPY pyproject.toml /app/pyproject.toml
COPY algotune.py /app/algotune.py
COPY requirements.txt /app/requirements.txt
COPY slurm/runscripts /opt/runscripts
COPY config.env /opt/config.env

# Install build dependencies and git
RUN apt-get update && apt-get install -y --no-install-recommends \
        git \
        build-essential \
        && rm -rf /var/lib/apt/lists/*

# Upgrade pip
RUN python3 -m pip install --upgrade pip

# Install your project (editable, like your Singularity spec)
RUN python3 -m pip install -e .

# Install additional Python deps
RUN python3 -m pip install --no-cache-dir -r /app/requirements.txt

# Default entrypoint for AWS Batch
ENTRYPOINT ["/bin/bash", "-lc"]
CMD ["echo 'AlgoTune container environment ready.'"]
